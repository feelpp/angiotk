#!/usr/bin/env python                                                                                                                                                                                                                         

import argparse
import ConfigParser
import os
import shutil
import sys
import time
# to read results database (json file)
import json
from collections import OrderedDict
import string
import errno
# check if file exists
def sanityCheckFile(filepath, msg=""):
    if( not os.path.exists(filepath) ):
        if(msg != ""):
            print msg + "\nAborting ..."
        else:
            print "The file " + filepath + " was not found\nAborting ..."
        exit(1)

# make a directory (don't fail if it exists)                                                                                                                                                                                                 
def makedir(path):
    try:
        os.makedirs(path)
    except OSError as exc:
        if exc.errno == errno.EEXIST and os.path.isdir(path):
            pass
        else: raise

def sanityCheckFile(filepath, msg=""):
    if( not os.path.exists(filepath) ):
        if(msg != ""):
            print msg + "\nAborting ..."
        else:
            print "The file " + filepath + " was not found\nAborting ..."
        exit(1)

def main():
    
    # parse arguments
    parser = argparse.ArgumentParser()
    parser.add_argument('-i', required=True, help='Path to the original database in json format')
    parser.add_argument('-o', required=False, default="", help='Desired output asciidoc file')
    args = parser.parse_args()
    # prepare i/o paths and filenames
    jsonFile = args.i # usually $RESULTS/resultsDataBase/results.json
    sanityCheckFile(jsonFile) # check file existence
    baseName, ext = os.path.splitext(os.path.basename(args.i)) # separate $RESULTS/resultsDataBase  and results.json
    if args.o=="":
        fileNoExt, ext = os.path.splitext(args.i)
        asciidocFile = fileNoExt + '.adoc' # usually -> #RESULTS/resultsDataBase/results.json 
        print 'createAsciidocDB.py: No output specified, using input file name with .adoc extention: ' + asciidocFile
    else:
        makedir(args.o) # create output directory if needed
        asciidocFile = args.o # usually -> #RESULTS/resultsDataBase/results.json

    # ------------ Results Database initialization -------------                                                                                                                                                                             
    # initialize database by reading existing file or creating one if needed.
    resultsDB = OrderedDict()
    try:
        dbFile = open(jsonFile,'r')
        resultsDB = json.load(dbFile, object_pairs_hook=OrderedDict)
        dbFile.close()
    except Exception, e:
        print 'createAsciidocDB.py: ', e
    
    adocFile = open(asciidocFile, 'w')

    #print 'RESULTS DB:'
    #print json.dumps(resultsDB, indent=4)
    #print ''

    # write configuration
    adocFile.write("##Configuration\n\n")
    for info, value in resultsDB['configuration'].items():
        adocFile.write('- ' + str(info) + ": " + str(value) + '\n')
    adocFile.write('\n')
    # write text before table
    adocFile.write("##Results table:\n\n")
    # write table title
    #adocFile.write(':tabletags-red.bodydata: <td style=\"background-color:red;\">|</td>\n')
    #adocFile.write(':tabledef-default.red-style: tags=\"red\"\n\n')
    adocFile.write(".Results table\n")
    # write columns titles (i.e. the top row)
    adocFile.write("[style=\"verse,asciidoc\",options=\"header,footer\"]\n")
    adocFile.write("|===\n")
    adocFile.write("|Dataset\Steps")
    pipelineSteps = next (iter(resultsDB['results'].values()))
    for step in pipelineSteps:
        adocFile.write('|'+step)
    adocFile.write("\n\n")
    # write other rows
    for dataset, pipelineSteps in resultsDB['results'].items():
        adocFile.write('|{set:cellbgcolor!}\n')
        adocFile.write(dataset)
        wasRed=False
        for stepName, step in pipelineSteps.items():
            adocFile.write('|')
            adocFile.write('Time: ' + str(step['Time']) + ' +\n')
            picLink = step['Screenshot']
            adocFile.write('image:' + str(picLink) + '[\"screenshot\",width=100,link=\"' + str(picLink) + '\"] +\n')
            for metadataName, metadata in step.items():
                if metadataName == 'Success':
                    if metadata == False: # step failure
                        if not wasRed:
                            adocFile.write('{set:cellbgcolor:red}\n')
                            wasRed = True
                    else: # step success
                        if wasRed:
                            adocFile.write('{set:cellbgcolor!}\n')
                            wasRed = False
                elif (metadataName != 'Command') and (metadataName != 'Screenshot') and (metadataName != 'Time') and (metadataName != 'Users comments') :
                    if (metadataName == 'Output') and (metadata != 'void'):
                        adocFile.write( 'link:' +  str(metadata) + '[Output file] +\n')
                    else:
                        adocFile.write( metadataName + ': ' + str(metadata) + ' +\n')
        adocFile.write("\n")
    adocFile.write("|===\n")
    
    adocFile.close()

# Only do this, if we do not import as a module                                                                                                                                                                                               
if __name__ == "__main__":
    main()
