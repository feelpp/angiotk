# Using Docker (Preferred method)

Docker will greatly simplify the building of AngioTK, by automatically building the library and the associated dependencies, and their dependencies.

To do so, you must install two components. The docker engine component, that will allow you to use all the docker components, and docker-compose, that will allow you to build the different images needed for AngioTK.

Once they are both installed, go into your local clone of AngioTK and then type:

```
docker-compose build
```

All the required images will then be built. It might take some time.
Eventually, you can use the container where AngioTK has been built with the following command:

```
docker run -ti feelpp/angiotk:latest
```

# Step by step building documentation 

Some dependecies must be installed in order to build and install AngioTK.

## Feel++ 

AngioTK needs the Feel++ library to be installed, and the `FEELPP_DIR` environment variable to reference its install directory (which is defined before compiler using the `-DCMAKE_INSTALL_PREFIX=` flag). 

### Feel++ requirements

Please refer to the Feel++ documentation for further instructions on how to build and/or install Feel++

As of today (may 2017), Feel++ installation has been successfully tested with the following environment:

##### Compiling requirements
- gcc 6.1.0
- clang 4.0.0
- CMake 3.6.1

##### Other dependencies
- openmpi 1.10.2
- boost 1.61
- petsc 3.6.4
- slepc 3.6.3
- gmsh 2.13.1
- hdf5 1.8.17
- VTK 7.0.0
- ParaView 5.1.0
- fftw 3.3.4

### Building the Feel++ library

You should set the `CC` and `CXX` environment variables to refer to clang and clang++ respectively.

##### Cloning sources (using git)

You need a suitable directory to clone the sources. For example, let's assume you clone the sources in a subdirectory in your home directory: 

```
mkdir $HOME/git
cd $HOME/git
git clone https://github.com/feelpp/feelpp.git
```
The sources have been cloned to `$HOME/git/feelpp/`. You also need a build directory ***outside*** of the source directory. Let's assume we build in an other subdirectory in your home directory:

```
mkdir $HOME/build
mkdir $HOME/build/feelpp
cd $HOME/build/feelpp
```
Tell CMake where the source are, where to install the library (for example `$HOME/install/feelpp`) as well as build options. 

```
cmake $HOME/git/feelpp -DCMAKE_INSTALL_PREFIX=$HOME/install/feelpp -DFEELPP_ENABLE_NLOPT=OFF -DCMAKE_BUILD_TYPE=Release
```
NOTE: Disabling nlopt is necessary until further notice.

You can now build Feel++ using make:

```
make install-feelpp-lib -j 4
```
NOTE: The `-j` flag allows you to define how many compiling processes can run simultaneously. Increasing this value should decrease compiling time, until you reach the CPU core count of your system. 


## Compilers

We strongly advise to compile all of AngioTK's dependencies using the same versions of GCC, Clang and CMake used to build Feel++. 

## ITK 4 or higher

AngioTK requires ITK version 4 or higher to be installed and the `ITK_DIR` environment variable to reference its install directory.

As of today (may 2017), AngioTK has been successfully compiled with ITK 4.12.0.

## VMTK 1.3

If you can install VMTK through your package system, you should do it this way, it would be easier. 

As of today (may 2017), AngioTK has been successfully compiled with VMTK 1.3.

### building VMTK

If you prefer to build VMTK, the easiest way to do it is with the SuperBuild option. It will build VMTK and all its dependencies in a single directory, you will thus avoid compatibility issues.

First clone vmtk with git and select the version you want:

```
# Cloning vmtk and go into the directory
git clone https://github.com/vmtk/vmtk.git
cd vmtk

# By default, you will be on top of the master branch
# If you want to switch to a previous release, use the git checkout command
# To check available releases, use the git show-ref command

# Example: going to VMTK 1.2
git checkout refs/tags/v1.2

# Example: going to VMTK 1.3
git checkout refs/tags/v1.3
```

By default VMTK will perform a SuperBuild, you can use the following commands (in the vmtk directory):

```
# First create a build directory to build outside of the source code 
mkdir build
cd build

# The use the following command template
# cmake <vmtk_source_dir>
# You can specify the SuperBuild install prefix with -DSUPERBUILD_INSTALL_PREFIX=...
# By default, it will be installed in <builddir>/Install
cmake ..
make -j <njobs>
```   
   
Export the VMTK_DIR or VMTKHOME variable to the install directory to make it available to AngioTK.

For all those libraries, you might need to setup `PATH`, `LD_LIBRARY_PATH`, `CMAKE_PREFIX_PATH` ... or use the module command.

## Python 2 (and *not* python 3)

Python 2 is also required to run AngioTK. Python 3 will not work with AngioTK because it is not supported by VMTK 1.3.

## Building AngioTK

When all of the dependencies are installed, building AngioTK is fairly simple. You need three directories: one for the sources, one for the building step and one to install AngioTK.
Start by cloning the sources:

```
cd $HOME/git
git clone http://github.com/feelpp/angiotk.git
```
Then call CMake, specify the install directory and enable/disable modules.

```
mkdir $HOME/build/angiotk
cd $HOME/build/angiotk
cmake $HOME/git/angiotk -DCMAKE_INSTALL_PREFIX=$HOME/install/angiotk -DBUILD_MODULE_Filtering=OFF -DBUILD_MODULE_Meshing=ON -DBUILD_MODULE_CFD=OFF -DBUILD_MODULE_ParticleTracer=OFF -DBUILD_MODULE_CT_Segmentation=ON -DCMAKE_BUILD_TYPE=Release
```

Build AngioTK with make:

```
make -j 4
make install
```

Finally, call the environment setup script before using AngioTK: (it will export required environment variables)

```
source $HOME/install/angiotk/bin/setupAngioTKEnvironment.sh
```


You can now run the pipeline scripts in:

```
$HOME/install/angiotk/bin/
```

Or call the modules individually, for example:

```
meshing_surfacefromimage <...>
```