# Using Docker (Preferred method)

Docker will greatly simplify the building of AngioTK, by automatically building the library and the associated dependencies, and their dependencies.

To do so, you must install two components. The docker engine component, that will allow you to use all the docker components, and docker-compose, that will allow you to build the different images needed for AngioTK.

Once they are both installed, go into your local clone of AngioTK and then type:

```
docker-compose build
```

All the required images will then be built. It might take some time.
Eventually, you can use the container where AngioTK has been built with the following command:

```
docker run -ti feelpp/angiotk:latest
```

# Step by step building documentation 

## Initial setup

Make sur you have all the dependencies installed for both feel++ and angiotk.

Feel++ requires at least:

* openmpi
* petsc/slepc
* gmsh
* boost

Advice regarding to compiler: prefer the use of clang instead of gcc (less memory and less compilation time).

Angiotk requires at least:

* Feel++
* openmpi
* ITK
* vmtk

## Building

### Feel++

To build Feel++, please refer to the Feel++ documentation.
You will have to install Feel++, so you might want to set up an installation path with `-DCMAKE_INSTALL_PREFIX="..."` (if you don't want to install Feel++ in your system), then build and install Feel++ with `make install-feelpp`.

Once Feel++ is installed, you need to export the `FEELPP_DIR` variable in your shell (e.g. put it in your .bashrc file). Set it to the installation directory of Feel++ (to one you previously set at the cmake step).

### VMTK

If you can install vmtk through your package system, you should do it this way, it would be easier. 

It is not advised to use VMTK SuperBuild, as installed dependencies ITK and VTK are not located in the same place in different versions, making it harder to detect them correctly.

If you need to build vmtk, pay attention to the library versions you will use.
As of version 1.2, it has been built successfully with ITK 4.9.1 and VTK 5.8 and 5.10.1. Version 1.3 builds with VTK 6.0 

Confirmed cmake working commands for installation:   
* ITK 4.9.1:
    
```
git clone git://github.com/Kitware/ITK.git
git checkout refs/tags/v4.9.1

cd ITK
mkdir build
cd build

#cmake .. -DCMAKE_INSTALL_PREFIX=<itk_install_dir> -DBUILD_EXAMPLES=ON -DITKV3_COMPATIBILITY=ON -DITK_USE_REVIEW=ON -DBUILD_SHARED_LIBS=ON

cmake .. -DBUILD_EXAMPLES=OFF -DBUILD_TESTING=OFF -DBUILD_SHARED_LIBS=ON -DModule_ITKReview=ON -DCMAKE_INSTALL_PREFIX=/data/software/install/ITK/4.9.1
```


`ITKV3_COMPATIBILITY` and `Module_ITKReview` are required for vmtk to work. There is a code example that allows to convert DICOM data to the mha format.   
   
Export the ITK_DIR variable to the install directory.

* VTK 5.10.1:   
```
cmake <vtk_source_dir> -DCMAKE_INSTALL_PREFIX=<vtk_install_dir> -DVTK_Group_MPI=ON -DVTK_Group_Qt=ON -DBUILD_SHARED_LIBS=ON -DVTK_WRAP_PYTHON=ON
```   
You need at least `VTK_WRAP_PYTHON`.
   
Export the VTK_DIR variable to the install directory.
   
* VMTK 1.2   
```
cmake <vmtk_source_dir> -DUSE_SYSTEM_ITK=ON -DUSE_SYSTEM_VTK=ON
```   
Here we use the ITK and VTK that we just configured and installed in the system.
   
Export the VMTK_DIR or VMTKHOME variable to the install directory.

For all those libraries, you might need to setup `PATH`, `LD_LIBRARY_PATH`, `CMAKE_PREFIX_PATH` ... or use the module command.

<!--
If you prefer to build VMTK, the easiest way to do it is with the SuperBuild option. It will build VMTK and all its dependencies in a single directory, you will thus avoid compatibility issues.

First clone vmtk with git and select the version you want:

```
# Cloning vmtk and go into the directory
git clone https://github.com/vmtk/vmtk.git
cd vmtk

# By default, you will be on top of the master branch
# If you want to switch to a previous release, use the git checkout command
# To check available releases, use the git show-ref command

# Example: going to VMTK 1.2
git checkout refs/tags/v1.2

# Example: going to VMTK 1.3
git checkout refs/tags/v1.3
```

By default VMTK will perform a SuperBuild, you can use the following commands (in the vmtk directory):

```
# First create a build directory to build outside of the source code 
mkdir build
cd build

# The use the following command template
# cmake <vmtk_source_dir>
# You can specify the SuperBuild install prefix with -DSUPERBUILD_INSTALL_PREFIX=...
# By default, it will be installed in <builddir>/Install
cmake ..
make -j <njobs>
```   

-->
   
Export the VMTK_DIR or VMTKHOME variable to the install directory to make it available to AngioTK.

For all those libraries, you might need to setup `PATH`, `LD_LIBRARY_PATH`, `CMAKE_PREFIX_PATH` ... or use the module command.

### Feel++

Regarding to building Feel++, please refer to the Feel++ documentation.
An important point to note is that you have to ensure the compatibility with VMTK if you enable VTK in Feel++ (It is enabled by default). 
To do so, you must ensure that you are using the exact same version of VTK, in Feel++ and VMTK.
Possible errors might come from the fact that you enabled In-situ in Feel++. In this case, the typical VTK version used will be the one bundled with ParaView, which is often more recent that system versions.

You will have to install Feel++, so you might want to set up an installation path with `-DCMAKE_INSTALL_PREFIX="..."` (if you don't want to install Feel++ in your system), then build and install Feel++ with `make install-feelpp-lib`.

Once Feel++ is installed, you need to export the `FEELPP_DIR` variable in your shell (e.g. put it in your .bashrc file). Set it to the installation directory of Feel++ (that you previously set at the cmake step).

### Angiotk

To build the angiotk environment, first clone the angiotk repository.

Then build and activate modules that you require.   
For example, if you only want to enable the `Meshing` module:
```   
cmake /home/aancel/git/angiotk -DBUILD_MODULE_Meshing=ON
```

If your build fails, then the problem must come from the previous installations that you have done. Please re-check them.
